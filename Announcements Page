# ðŸ“¢ ANNOUNCEMENTS PAGE â€” Meetika Kanumukula (updated version)

import sqlite3
import pandas as pd
from datetime import datetime
import ipywidgets as widgets
from IPython.display import display, clear_output, Markdown

# -- Ensure table exists --
conn = sqlite3.connect('school_system.db')
cursor = conn.cursor()
cursor.execute('''
CREATE TABLE IF NOT EXISTS Announcements (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    author_id INTEGER,
    role_visibility TEXT,   -- e.g., 'student,parent' or 'all'
    course_id INTEGER,
    title TEXT,
    body TEXT,
    created_at TEXT
)
''')
conn.commit()

def _get_course_options():
    """
    For teachers: return only their courses.
    For admins: return all courses.
    Others: return empty list (courses optional).
    """
    if current_session['role'] == 'teacher':
        tid = current_session['teacher_id']
        cursor.execute("SELECT course_id, course_name FROM Courses WHERE teacher_id = ?", (tid,))
    elif current_session['role'] == 'admin':
        cursor.execute("SELECT course_id, course_name FROM Courses")
    else:
        return []
    return cursor.fetchall()

def _create_announcement_form():
    """Form for teachers/admins to create announcements."""
    title_input = widgets.Text(description='Title:', placeholder='Enter title')
    body_input = widgets.Textarea(description='Body:', placeholder='Enter body text')
    visibility_input = widgets.Dropdown(
        options=[
            ('All', 'all'),
            ('Students', 'student'),
            ('Parents', 'parent'),
            ('Teachers', 'teacher'),
            ('Admins', 'admin'),
            ('Students & Parents', 'student,parent'),
            ('Teachers & Parents', 'teacher,parent')
        ],
        description='Visible to:',
        value='all'
    )
    courses = _get_course_options()
    course_input = widgets.Dropdown(
        options=[('None', None)] + [(name, cid) for cid, name in courses],
        description='Course:'
    )
    submit_btn = widgets.Button(description='Post Announcement', button_style='success')

    def on_submit(b):
        author_id = current_session['user_id']
        created_at = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        cursor.execute(
            '''
            INSERT INTO Announcements (author_id, role_visibility, course_id, title, body, created_at)
            VALUES (?, ?, ?, ?, ?, ?)
            ''',
            (
                author_id,
                visibility_input.value,
                course_input.value,
                title_input.value.strip(),
                body_input.value.strip(),
                created_at
            )
        )
        conn.commit()
        clear_output()
        print("âœ… Announcement posted!\n")
        # Show announcements again after posting
        display_announcements()

    submit_btn.on_click(on_submit)
    display(Markdown("### âœï¸ Add Announcement"))
    display(title_input, body_input, visibility_input, course_input, submit_btn)

def display_announcements(course_id=None):
    """
    Show announcements for the current user.
    Filters by role and (optional) course.
    """
    user_role = current_session['role'].lower()  # e.g., 'teacher', 'student'
    if course_id:
        query = """
            SELECT title, body, role_visibility, created_at
            FROM Announcements
            WHERE
              (role_visibility = 'all' OR instr(role_visibility, ?) > 0)
              AND (course_id IS NULL OR course_id = ?)
            ORDER BY datetime(created_at) DESC
        """
        df = pd.read_sql_query(query, conn, params=(user_role, course_id))
    else:
        query = """
            SELECT title, body, role_visibility, created_at
            FROM Announcements
            WHERE role_visibility = 'all' OR instr(role_visibility, ?) > 0
            ORDER BY datetime(created_at) DESC
        """
        df = pd.read_sql_query(query, conn, params=(user_role,))

    if df.empty:
        print("No announcements available for your role at this time.\n")
    else:
        display(df[['created_at', 'title', 'body']])

def announcements_page():
    """
    Master function to show the announcements page.
    Teachers/Admins can post; everyone can view.
    """
    display(Markdown("## ðŸ“¢ Announcements"))
    display_announcements()
    if current_session['role'] in ['teacher', 'admin']:
        _create_announcement_form()











announcements_page()
# Meetika Kanumukula




if current_session:
    display_announcements()

else:
    print("Please log in first to access the announcements menu.")
    # Meetika Kanumukula




if current_session:
    announcements_page()
else:
    print("Please log in first to access the teacher/admin dashboard.")




